<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>/home/developer/workspace/openveo-portal/app/server/passport/cas/CAS.js - OpenVeo Portal server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Portal server</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 1.1.1
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/CAS.html">CAS</a></li>
                                <li><a href="../classes/CAS 2.html">CAS 2</a></li>
                                <li><a href="../classes/CAS1.html">CAS1</a></li>
                                <li><a href="../classes/CAS3.html">CAS3</a></li>
                                <li><a href="../classes/CasStrategy.html">CasStrategy</a></li>
                                <li><a href="../classes/defaultController.html">defaultController</a></li>
                                <li><a href="../classes/errorController.html">errorController</a></li>
                                <li><a href="../classes/filterCache.html">filterCache</a></li>
                                <li><a href="../classes/migrationLoader.html">migrationLoader</a></li>
                                <li><a href="../classes/searchController.html">searchController</a></li>
                                <li><a href="../classes/Server.html">Server</a></li>
                                <li><a href="../classes/StatisticsController.html">StatisticsController</a></li>
                                <li><a href="../classes/VideoCache.html">VideoCache</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/controllers.html">controllers</a></li>
                                <li><a href="../modules/core-loaders.html">core-loaders</a></li>
                                <li><a href="../modules/http-errors.html">http-errors</a></li>
                                <li><a href="../modules/passport.html">passport</a></li>
                                <li><a href="../modules/passport-cas.html">passport-cas</a></li>
                                <li><a href="../modules/portal-cache.html">portal-cache</a></li>
                                <li><a href="../modules/portal-controllers.html">portal-controllers</a></li>
                                <li><a href="../modules/server.html">server</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: /home/developer/workspace/openveo-portal/app/server/passport/cas/CAS.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 * @module passport-cas
 */

const fs = require(&#x27;fs&#x27;);
const path = require(&#x27;path&#x27;);
const url = require(&#x27;url&#x27;);
const xml2js = require(&#x27;xml2js&#x27;);
const http = require(&#x27;http&#x27;);
const https = require(&#x27;https&#x27;);

/**
 * Defines a cas client.
 *
 * A cas client is responsible of the protocol to communicate with the cas server.
 *
 * @example
 *     e.g. Configuration example
 *     // {
 *     //   &quot;url&quot;: &quot;https://openveo-cas.com:8443/cas&quot;, // CAS server url
 *     //   &quot;version&quot;: &quot;4&quot;, // CAS version (could be 1, 2, 3, 4)
 *     //   &quot;certificate&quot;: &quot;/home/test/cas.crt&quot; // CAS certificate public key
 *     // }
 *
 * @class CAS
 */
class CAS {

  /**
   * Creates a new cas client.
   *
   * @constructor
   * @param {Object} options The list of cas strategy options
   */
  constructor(options) {
    if (!options.url)
      throw new Error(&#x27;Missing cas server url for cas client&#x27;);

    if (!options.certificate)
      throw new Error(&#x27;Missing cas certificate for cas client&#x27;);

    const urlChunks = url.parse(options.url);

    Object.defineProperties(this, {

      /**
       * CAS server url.
       *
       * @property url
       * @type String
       */
      url: {
        value: options.url
      },

      /**
       * Cas server certificate&#x27;s public key.
       *
       * @property certificate
       * @type String
       */
      certificate: {
        value: options.certificate
      },

      /**
       * CAS server host.
       *
       * @property host
       * @type String
       */
      host: {
        value: urlChunks.hostname
      },

      /**
       * CAS server protocol, either http or https.
       *
       * @property protocol
       * @type String
       */
      protocol: {
        value: urlChunks.protocol === &#x27;http:&#x27; ? &#x27;http&#x27; : &#x27;https&#x27;
      },

      /**
       * Either the http or https client of NodeJS.
       *
       * @property httpClient
       * @type Object
       */
      httpClient: {
        value: urlChunks.protocol === &#x27;http:&#x27; ? http : https
      },

      /**
       * CAS server port.
       *
       * @property port
       * @type Number
       */
      port: {
        value: urlChunks.port || (this.protocol === &#x27;http&#x27; ? 80 : 443)
      },

      /**
       * CAS server uri (usally /cas).
       *
       * @property path
       * @type String
       */
      path: {
        value: urlChunks.path
      },

      /**
       * CAS server login uri.
       *
       * @property loginUri
       * @type String
       */
      loginUri: {
        value: this.getLoginUri()
      },

      /**
       * CAS server validate uri.
       *
       * @property validateUri
       * @type String
       */
      validateUri: {
        value: this.getValidateUri()
      }

    });

  }

  /**
   * Gets validate uri.
   *
   * @method getValidateUri
   * @return {String} The validate uri
   */
  getValidateUri() {
    return &#x27;/serviceValidate&#x27;;
  }

  /**
   * Gets login uri.
   *
   * @method getLoginUri
   * @return {String} The login uri
   */
  getLoginUri() {
    return &#x27;/login&#x27;;
  }

  /**
   * Gets logout uri.
   *
   * @method getLogoutUri
   * @return {String} The logout uri
   */
  getLogoutUri() {
    return &#x27;/logout&#x27;;
  }

  /**
   * Gets cas server url.
   *
   * @method getUrl
   * @return {String} Cas server url
   */
  getUrl() {
    return this.url;
  }

  /**
   * Validates a ticket using cas.
   *
   * @async
   * @method validateTicket
   * @param {String} service Cas registered service
   * @param {String} ticket Ticket to validate
   * @return {Promise} Promise resolving with cas user information (name and attributes)
   */
  validateTicket(service, ticket) {
    const self = this;

    return new Promise((resolve, reject) =&gt; {
      const options = {
        hostname: this.host,
        port: this.port,
        path: &#x60;${this.path}${this.validateUri}?service=${service}&amp;ticket=${ticket}&#x60;,
        method: &#x27;GET&#x27;,
        rejectUnauthorized: process.env.NODE_ENV === &#x27;production&#x27;,
        cert: fs.readFileSync(path.normalize(this.certificate))
      };

      options.agent = new this.httpClient.Agent(options);

      const request = this.httpClient.request(options, (response) =&gt; {
        response.setEncoding(&#x27;utf8&#x27;);

        let body = &#x27;&#x27;;
        response.on(&#x27;data&#x27;, (chunk) =&gt; {
          return body += chunk;
        });

        response.on(&#x27;end&#x27;, () =&gt; {
          self.analyzeValidateTicketResponse(body).then((result) =&gt; {
            resolve(result);
          }).catch((error) =&gt; {
            reject(error);
          });
        });

        response.on(&#x27;error&#x27;, (error) =&gt; reject(error));

      });

      request.on(&#x27;error&#x27;, (error) =&gt; reject(error));
      request.setTimeout(10000, () =&gt; {
        request.abort();
        reject(&#x27;CAS server unavaible&#x27;);
      });

      request.end();
    });
  }

  /**
   * Analyzes the validate ticket response from cas server.
   *
   * @param {String} response Validate ticket response from cas server
   * @return {Promise} Promise resolving with cas user information (name and attributes)
   */
  analyzeValidateTicketResponse(response) {
    return new Promise((resolve, reject) =&gt; {

      // Parse XML data from CAS server
      xml2js.parseString(response, {
        trim: true,
        mergeAttrs: true,
        normalize: true,
        explicitArray: false,
        tagNameProcessors: [xml2js.processors.firstCharLowerCase, xml2js.processors.stripPrefix]
      }, (error, results) =&gt; {
        if (error)
          return reject(error);

        if (!results)
          return reject(new Error(&#x27;No response from cas server&#x27;));

        try {
          const failure = results.serviceResponse.authenticationFailure;
          const success = results.serviceResponse.authenticationSuccess;

          if (failure)
            return reject(new Error(failure.code));
          else if (success)
            return resolve({
              name: success.user,
              attributes: success.attributes
            });

          return reject(new Error(&#x27;Unknown error&#x27;));
        } catch (e) {
          return reject(e);
        }
      });

    });
  }

}

module.exports = CAS;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
